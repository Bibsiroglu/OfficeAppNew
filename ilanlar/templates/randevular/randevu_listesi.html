{% extends "base.html" %}

{% load static %}
{% load humanize %} {# Ã–rneÄŸin sayÄ±larda binlik ayÄ±rÄ±cÄ± kullanmak isterseniz (opsiyonel) #}

{% block title %}Randevu Listesi ve Ä°statistikleri{% endblock title %}

{% block content %}
<div class="row">

    {# Randevu Ä°statistikleri ve Grafik AlanÄ± (Sol/Ãœst KÄ±sÄ±m) #}
    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white">
                ğŸ“Š Randevu Durum DaÄŸÄ±lÄ±mÄ±
            </div>
            <div class="card-body">
                <canvas id="randevuDurumGrafigi"></canvas>
            </div>
            <div class="card-footer text-muted">
                Toplam Randevu: <strong class="text-dark">{{ toplam_randevu_sayisi|intcomma }}</strong>
            </div>
        </div>
    </div>

    {# Randevu Listesi AlanÄ± (SaÄŸ/Alt KÄ±sÄ±m) #}
    <div class="col-lg-8">
        <h2 class="mb-4">ğŸ“… TÃ¼m Randevular (Toplam {{ page_obj.paginator.count }} Adet)</h2>

        <p>
            <a href="{% url 'ilan_listesi' %}" class="btn btn-secondary btn-sm">ğŸ¡ Ä°lan Listesi</a>
            <a href="/admin/ilanlar/randevu/add/" class="btn btn-primary btn-sm">â• Yeni Randevu Ekle</a>
        </p>

        <div class="list-group shadow-sm">
            {# --- BAÅLIK SATIRI (SÃ¼tunlar) --- #}
            <div class="list-group-item list-group-item-action bg-dark text-white d-none d-md-flex py-3">
                <div class="col-md-2 fw-bold">Tarih/Saat</div>
                <div class="col-md-2 fw-bold">MÃ¼ÅŸteri (AdÄ±/SoyadÄ±)</div>
                <div class="col-md-2 fw-bold">Telefon</div>
                <div class="col-md-4 fw-bold">Ä°lgili Ä°lan</div>
                <div class="col-md-2 fw-bold text-center">Durum / Aksiyon</div>
            </div>

            {# --- RANDEVU LÄ°STESÄ° DÃ–NGÃœSÃœ --- #}
            {% for randevu in randevular %}
            <div class="list-group-item list-group-item-action d-flex flex-wrap align-items-center py-3">

                {# 1. TARÄ°H/SAAT (col-md-2) #}
                <div class="col-md-2 mb-2 mb-md-0">
                    <span class="fw-bold">{{ randevu.tarih_saat|date:"d.m.Y" }}</span>
                    <small class="d-block text-muted">{{ randevu.tarih_saat|date:"H:i" }}</small>
                </div>

                {# 2. MÃœÅTERÄ° ADI SOYADI (col-md-2) #}
                <div class="col-md-2 mb-2 mb-md-0 text-truncate">
                    {% with musteri=randevu.potansiyel_musteri %}
                    <a href="/admin/ilanlar/potansiyelmusteri/{{ musteri.pk }}/change/"
                        class="mb-0 fw-bold text-primary text-decoration-none">
                        {{ musteri.ad }} {{ musteri.soyad }}
                    </a>
                    {% endwith %}
                </div>

                {# 3. TELEFON (col-md-2) #}
                <div class="col-md-2 mb-2 mb-md-0">
                    <i class="fas fa-phone me-1 text-info"></i>
                    <span class="text-secondary">{{ randevu.potansiyel_musteri.telefon }}</span>
                </div>

                {# 4. Ä°LGÄ°LÄ° Ä°LAN (col-md-4) #}
                <div class="col-md-4 mb-2 mb-md-0 text-truncate">
                    {% if randevu.ilan %}
                    <a href="{% url 'ilan_detay' pk=randevu.ilan.pk %}" title="{{ randevu.ilan.baslik }}">
                        {{ randevu.ilan.ilan_no }} - {{ randevu.ilan.baslik|truncatechars:30 }}
                    </a>
                    {% else %}
                    - Ä°lan BaÄŸlantÄ±sÄ± Yok -
                    {% endif %}
                </div>

                {# 5. DURUM VE AKSÄ°YONLAR (col-md-2) #}
                <div class="col-md-2 text-center">
                    {% with durum_kisa=randevu.durum %}

                    {# --- MEVCUT DURUM ROZETÄ° (GÃ–STERÄ°M) --- #}
                    <div class="mb-2">
                        {% if durum_kisa == 'TAMAM' %}
                        <span class="badge bg-success">{{ randevu.get_durum_display }}</span>
                        {% elif durum_kisa == 'IPTAL' %}
                        <span class="badge bg-danger">{{ randevu.get_durum_display }}</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">{{ randevu.get_durum_display }}</span>
                        {% endif %}
                    </div>

                    {# --- DURUM DEÄÄ°ÅTÄ°RME BUTON GRUBU --- #}
                    <div class="btn-group btn-group-sm mb-2" role="group">
                        {# Tamamla Butonu #}
                        {% if durum_kisa != 'TAMAM' %}
                        <a href="{% url 'randevu_durum_degistir' pk=randevu.pk yeni_durum='TAMAM' %}"
                            class="btn btn-success" title="Randevuyu Tamamla">
                            <i class="fas fa-check"></i>
                        </a>
                        {% endif %}

                        {# Ä°ptal Et Butonu #}
                        {% if durum_kisa != 'IPTAL' %}
                        <a href="{% url 'randevu_durum_degistir' pk=randevu.pk yeni_durum='IPTAL' %}"
                            class="btn btn-danger" title="Randevuyu Ä°ptal Et">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}

                        {# Tekrar Planla Butonu #}
                        {% if durum_kisa != 'PLAN' %}
                        <a href="{% url 'randevu_durum_degistir' pk=randevu.pk yeni_durum='PLAN' %}"
                            class="btn btn-info" title="PlanlandÄ± Durumuna Ã‡ek">
                            <i class="fas fa-undo"></i>
                        </a>
                        {% endif %}
                    </div>

                    {# Randevu dÃ¼zenleme linki (Admin) #}
                    <a href="/admin/ilanlar/randevu/{{ randevu.pk }}/change/"
                        class="btn btn-sm btn-outline-secondary d-block mt-1">DÃ¼zenle</a>

                    {% endwith %}
                </div>
            </div>
            {% empty %}
            <div class="list-group-item">
                <p class="alert alert-info mb-0">KayÄ±tlÄ± randevu bulunmamaktadÄ±r.</p>
            </div>
            {% endfor %}
        </div>

        {# Paginasyon Eklenmeli (varsayÄ±lan listview iÃ§in) #}

    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // SayÄ±sal deÄŸerler iÃ§in JSON.parse() kullanmak genellikle gereksizdir ve tÄ±rnak iÅŸareti eksikliÄŸi 
    // nedeniyle hata verebilir. DoÄŸrudan sayÄ±yÄ± alalÄ±m:
    const planlanan = JSON.parse('{{ planlanan_sayisi_7gun }}');
    const tamamlanan = JSON.parse('{{ tamamlanan_sayisi_7gun }}');
    const iptalEdilen = JSON.parse('{{ iptal_edilen_sayisi_7gun }}');

    const data = {
        labels: ['Planlanan', 'Tamamlanan', 'Ä°ptal Edilen'],
        datasets: [{
            data: [planlanan, tamamlanan, iptalEdilen],
            backgroundColor: [
                'rgb(54, 162, 235)', // Mavi
                'rgb(75, 192, 192)', // YeÅŸil
                'rgb(255, 99, 132)'  // KÄ±rmÄ±zÄ±
            ],
            hoverOffset: 4
        }]
    };

    const config = {
        type: 'pie', // Pasta grafiÄŸi
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                // Title, kart baÅŸlÄ±ÄŸÄ±nda olduÄŸu iÃ§in kapatÄ±ldÄ±.
                title: { display: false }
            }
        }
    };

    // GrafiÄŸi Ã§izmek iÃ§in gerekli komut
    new Chart(
        document.getElementById('randevuDurumGrafigi'),
        config
    );
</script>
{% endblock extra_js %}